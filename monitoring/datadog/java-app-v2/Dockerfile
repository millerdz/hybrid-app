#
# Build the app using maven in a container
#
FROM maven:3.5.2-jdk-8-alpine AS devenv
WORKDIR /usr/src/java-app 
COPY app/pom.xml .
RUN mvn -B -f pom.xml -s /usr/share/maven/ref/settings-docker.xml dependency:resolve
COPY ./app .
RUN mvn -B -s /usr/share/maven/ref/settings-docker.xml package -DskipTests

#
# deploy application to tomcat
#

FROM tomcat:7-jre8
LABEL maintainer="Sophia Parafina <sophia.parafina@docker.com>"

# tomcat-users.xml sets up user accounts for the Tomcat manager GUI
ADD tomcat/tomcat-users.xml $CATALINA_HOME/conf/

# ADD tomcat/catalina.sh $CATALINA_HOME/bin/
ADD tomcat/run.sh $CATALINA_HOME/bin/run.sh
RUN chmod +x $CATALINA_HOME/bin/run.sh

# add MySQL JDBC driver jar
ADD tomcat/mysql-connector-java-5.1.36-bin.jar $CATALINA_HOME/lib/

# create mount point for volume with application
WORKDIR $CATALINA_HOME/webapps/
COPY --from=devenv /usr/src/java-app/target/java-web.war .

# enable data dog
ADD apm/dd-java-agent.jar $CATALINA_HOME/lib/
ENV DD_AGENT_HOST=datadog-agent \ 
    DD_TRACE_AGENT_PORT=8126 \
    JAVA_OPTS="$JAVA_OPTS -javaagent:$CATALINA_HOME/lib/dd-java-agent.jar"

# start tomcat7 
EXPOSE 8080
CMD ["run.sh"]
